#!/bin/bash

DEPLOYMENT_FILE="messaging_app/blue_deployment.yaml"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"

echo "üöÄ Starting rolling update for Blue deployment..."

# Apply the updated deployment file
kubectl apply -f $DEPLOYMENT_FILE

# Monitor the rollout status
kubectl rollout status deployment/messaging-app-blue --namespace=$NAMESPACE

# Test for downtime using curl in a loop
APP_URL="http://$(minikube ip):$(kubectl get svc $SERVICE_NAME -o=jsonpath='{.spec.ports[0].nodePort}')"
echo "üåç Testing app for downtime on $APP_URL..."

for i in {1..30}; do
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL)
    if [ "$RESPONSE" -ne 200 ]; then
        echo "‚ö†Ô∏è Downtime detected! HTTP status: $RESPONSE"
    else
        echo "‚úÖ App responding with 200 OK"
    fi
    sleep 1
done

# Verify pods after rollout
echo "üì¶ Pods after update:"
kubectl get pods -l app=messaging-app,version=blue
