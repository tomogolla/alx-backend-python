#!/bin/bash
# Deploy blue and green versions of the app and check logs of the new version.

# Deploy the "blue" version of the app
echo "üöÄ Deploying the 'blue' version of the app..."
kubectl apply -f blue_deployment.yaml

# Deploy the "green" version alongside the blue one
echo "üöÄ Deploying the 'green' version of the app..."
kubectl apply -f green_deployment.yaml

# Apply service
echo "Applying service configuration..."
kubectl apply -f kubeservice.yaml

# Check the logs of the green pods for errors
echo "üîç Checking logs for the new 'green' pod..."
GREEN_POD=$(kubectl get pods -l version=green -o jsonpath='{.items[0].metadata.name}')
if [ -z "$GREEN_POD" ]; then
    echo "Could not find a green pod. Check deployment status."
    exit 1
fi
kubectl logs "$GREEN_POD"

echo "---"
echo "Blue-Green deployment setup complete!"
echo "To switch traffic from the blue version to the green version:"
echo "    1. Edit 'kubeservice.yaml' and change the 'selector.version' to 'green'."
echo "    2. Run 'kubectl apply -f kubeservice.yaml' to apply the change."
echo "    3. You can then safely delete the old 'blue' deployment."
