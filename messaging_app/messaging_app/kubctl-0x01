#!/bin/bash
# Script to scale the Django deployment, run a load test, and monitor resources.

DEPLOYMENT_NAME="django-app-deployment"
SERVICE_NAME="django-app-service"
APP_LABEL="app=django-messaging-app"

echo "### Scaling and Testing Script ###"

# Check if wrk is installed
if ! command -v wrk &> /dev/null
then
    echo "wrk could not be found. Please install it to run the load test."
fi

# Scale the deployment to 3 replicas
echo "Scaling deployment '$DEPLOYMENT_NAME' to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3

# Verify that 3 pods are running
echo "Verifying pods..."
kubectl get pods -l $APP_LABEL

# Port-forward the service to run the load test locally
echo "Setting up port-forward to service '$SERVICE_NAME' on localhost:8080..."
kubectl port-forward service/$SERVICE_NAME 8080:80 > /dev/null 2>&1 &
PF_PID=$!
sleep 2 # Give port-forward a moment to establish connection

# Perform load testing with wrk if it is installed
if command -v wrk &> /dev/null
then
    echo "Performing load test with wrk for 30 seconds..."
    wrk -t4 -c100 -d30s http://127.0.0.1:8080/
fi

# Stop the port-forwarding
kill $PF_PID

# Monitor resource usage of the pods
echo "Monitoring resource usage (CPU/Memory)..."
kubectl top pods -l $APP_LABEL

echo "### Script Finished ###"